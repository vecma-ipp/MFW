#!/bin/sh

curdir=`pwd`

if [ $# -le 2 -o $# -ge 8 ]
then
   echo "need 3/4/5 arguments: eqdsk_filename in_dir out_dir [pfactor [peop [nfppfun [TNZfile]]]"
   echo " defaults: pfactor=1, peop=0.5, nfppfun=4(array, otherwise set 1 for polynomial), TNZfile=0"
   exit
fi
   inexpeqend=$1
   jobname=$inexpeqend

# echo "writing $1 in ~/.testchease"
echo $1 >> $HOME/.testchease


pfactor=1.
if [ $# -ge 4 ]
then
  pfactor=$4
fi

peop=0.5
if [ $# -ge 5 ]
then
  peop=$5
fi

nfppfun=4
if [ $# -ge 6 ]
then
  nfppfun=$6
fi

TNZfile=0
if [ $# -ge 7 ]
then
  TNZfile=${7}
fi

# to restart from previous equilibrium and change B0EXP (B0EXP=-1.4)
NOUTname=$inexpeqend

expeqfile=$inexpeqend
exptnzfile=EXPTNZ_$inexpeqend

che_opt=1

filedir_in=$2
if [ $filedir_in = '.' ]
then
   filedir_in=`pwd`
fi

filedir_out=$3
if [ $filedir_out = '.' ]
then
   filedir_out=`pwd`
fi

os=`uname -s`
if [ $os = 'SunOS' ]
then
    crppbin=/users/crpp/bin; export crppbin
else
    crppbin=/home/sauter/bin; export crppbin
fi
echo $crppbin

# run on tmp:
tmpdir=/tmp/`date|sed s/[^0-9]//g`$$
mkdir $tmpdir
cd $tmpdir
mkdir core
pwd


echo "***               $inexpeqend" > chease_namelist
cat >>chease_namelist <<'EOF'
*** 
***NEGP=-1,NER= 1  TCV case with ECRH
*** NSURF=6,NEQDSK=1,  NEQDXTPO=-1
 &EQDATA
EOF
if [ $TNZfile -eq 1 ]
then
  echo " RELAX= 0.,  NDIAGOP= 0,  NBSEXPQ=1111," >> chease_namelist
else
  echo " RELAX= 0.,  NDIAGOP= 1,  NBSEXPQ=0000," >> chease_namelist
fi
cat >>chease_namelist <<'EOF'
 NPROPT=2,
 NIDEAL=6, NPLOT=1,    NTCASE=0,   NSMOOTH=1,
 NS=60,    NT=60,      NPSI=220,    NCHI=220, NISO=220, NTNOVA=12,
 NS=40,    NT=40,      NPSI=180,    NCHI=180, NISO=180, NTNOVA=12,
EOF
echo " CPRESS=$pfactor ,QSPEC=0.70,   CSSPEC=0.0," >> chease_namelist
cat >>chease_namelist <<'EOF'
 CFNRESS=1.00,
 NRSCAL=0, NCSCAL=2,   NTMF0=0,
 NBAL=0,   NBLOPT=0,     CFBAL=10.00, 

 NOPT=0,
 R0EXP=8.79999995E-01,

 NSURF=6,  ELONG=2.045,  TRIANG=0.7,  BEANS=0., CETA=0.24, SGMA=0.,
           ASPCT= 0.28123462E+00,
           ASPCT= 0.28,

 AT4=0.0, 27.926, -42.339, 16.664, 0.0,
 AT4=28.232, -48.496, 35.964, -14.26, 0.0,
 AT4=29500., -68768., 272720., -1147400., 2798300., -3873600., 2842600., -852840.,
 AT3=0.52719, 0.11069, -0.11517, -0.083952, 0.15572, -0.048391, 0., 0.
 AT3=0.52503, 0.92754, 0.21896, -2.4078, 8.1211, -13.87, 11.653, -3.7942,
 AT2=1.5145, 0.12811, -4.9335, 36.43, -120.88, 201.1, -163.58, 51.79, 
 AT2=1.5165, 0.14189, -5.0417, 36.759, -121.11, 200.38, -162.23, 51.152,
EOF
echo " ETAEI= 0.1, RPEOP= $peop,  RZION=1.5," >> chease_namelist
echo " NPPFUN=$nfppfun, NPP=1,      AP= 0.0,-0.8, 0.0, 0.0, " >> chease_namelist
echo " NFUNC=$nfppfun,  NSTTP=1,    AT= 0., -0.30761536E+01,0.72318357, 0.0, " >> chease_namelist
cat >>chease_namelist <<'EOF'
 NSOUR=8,

 NDIFPS=0, NDIFT=1,
 NMESHC=1, NPOIDC=2, SOLPDC=.70,CPLACE=.95,.99,1.0,
                                CWIDTH=.10,.02,.05,
 NMESHA=0, NPOIDA=1, SOLPDA=.60,APLACE=.00,.70,1.0,
                                AWIDTH=.05,.07,.05,
 NMESHA=2, NPOIDQ=6, SOLPDA=.10,QPLACE=0.95,0.95,1.0,2.0,3.00,4.0,4.0,
                                QWIDTH=0.06,.04,.08,.05,0.05,0.05,
 NMESHA=0, NPOIDQ=8, SOLPDA=.10,QPLACE=0.95,0.95,1.0,2.0,3.00,3.0 ,4.0,4.0,
                                QWIDTH=0.06,.04, .03,.06,  .05,0.01,0.04,.01
 NMESHA=2, NPOIDQ=2, SOLPDA=.60,QPLACE=1.00,1.00,1.00,2.00,2.00,2.00,3.00,3.00,4.00,4.00,
                                 QWIDTH=0.13,0.06,0.01,0.09,0.05,0.02,0.07,0.02,0.04,0.01,
 NMESHA=2, NPOIDQ=10, SOLPDA=.10,QPLACE=1.00,1.00,1.00,2.00,2.00,2.00,3.00,3.00,4.00,4.00,
                                 QWIDTH=0.13,0.06,0.01,0.09,0.05,0.02,0.07,0.02,0.04,0.01,
 NMESHA=0, NPOIDQ=10, SOLPDA=.10,QPLACE=1.00,1.00,2.00,2.00,3.00,3.00,4.00,4.00,4.41,4.41,
                                 QWIDTH=0.13,0.04,0.09,0.04,0.07,0.02,0.04,0.01,0.01,0.001,
 NMESHD=1, NPOIDD=2, SOLPDD=.60,DPLACE=-1.80,-1.80,4.0,
                                DWIDTH=.18,.08,.05,
 NMESHD=0, NPOIDD=2, SOLPDD=.60,DPLACE=-1.80,-1.80,4.0,
                                DWIDTH=.18,.08,.05,
 NMESHE=0, NPOIDE=4, SOLPDE=.50,EPLACE=-1.70,-1.70, 1.70, 1.70,
                                EWIDTH=.18,.08,.18,.08,
 EPSLON=1.0E-8, GAMMA=1.6666666667,
 NTURN=20, NBLC0=16,   NPPR=24,
 MSMAX=1,  NINMAP=40,  NINSCA=40,
 NSYM=0,   NEGP= 0,    NER=2, NV=40, NVEXP=1,  REXT=10.0, R0W=1., RZ0W=0.,
 NSYM=0,   NEGP=-2,    NER=2, NV=40, NVEXP=1,  REXT=10.0, R0W=1., RZ0W=0.,
 NSYM=0,   NEGP=-1,    NER=1, NV=40, NVEXP=1,  REXT=10.0, R0W=1., RZ0W=0.,
 NEQDSK=0,  NEQDXTPO=-1,
 NEQDSK=1,  NEQDXTPO=1,
 PSISCL= 1.0,  NRBOX=33, NZBOX=33,
 PSISCL= 1.0,  NRBOX=33, NZBOX=65,
 PSISCL= 1.0,  NRBOX=129, NZBOX=129,
 PSISCL= 1.0,  NRBOX=257, NZBOX=257,
 PSISCL= 1.0,  NRBOX=157, NZBOX=157,
 /
 &NEWRUN
 AL0=-3.0E-03, NWALL= 1, REXT=10.0,
 NLGREN= .F., WNTORE=1.0, NV=40,
 NLDIAG=11*.T.,
 NAL0AUTO=1,
 /
EOF
cat chease_namelist
#
#     Run CHEASE
#
if [ $che_opt = '1' ]
then
  cp chease_namelist $filedir_out/o.$jobname
  echo "" >> $filedir_out/o.$jobname
  cp $filedir_in/$expeqfile EQDSK
  cp $filedir_in/$expeqfile EQDSK.NSURF10
#  $crppbin/bndfit << EOF >> $filedir_out/o.$jobname
# 10  NSURF
# 2 IFFT
# 200 NEQUIRHO
# 1.E-3 0.3 TAUS
#  -1001.  ZSHIFT
#EOF
ls -al
      cp EQDSK.NSURF10 EXPEQ
#      cp fort.8 /tmp/vis4/fort.8.bndfit
      cp $filedir_in/$exptnzfile EXPTNZ 2> /dev/null
      cp $filedir_in/$expdatafile EXPDATA 2> /dev/null
      cp $filedir_in/NOUT.$NOUTname NIN 2>/dev/null

      echo " " >> $filedir_out/o.$jobname
#      /users/sauter/CHEASE/V90_1_1/chease/src-f90/chease >> $filedir_out/o.$jobname
      $crppbin/chease >> $filedir_out/o.$jobname
      ls -al
      cp EQDSK.OUT $filedir_out/EQDSK.$jobname
      cp EXPEQ.OUT $filedir_out/EXPEQ.OUT.$jobname
      cp EXPEQ.OUT.TOR $filedir_out/EXPEQ.OUT.TOR.$jobname
      cp EQDSKSGN.OUT $filedir_out/EQDSKSGN.OUT.$jobname
      cp EXPTNZ.OUT $filedir_out/EXPTNZ.OUT.$jobname
      cp NUPLO /tmp/NUPLO.$jobname
      cp chease.dat /tmp/chease.dat.$jobname
      cp NOUT $filedir_out/NOUT.$jobname
      date

echo " "
echo ""
echo " Chease done"
echo ""
grep -v $1 $HOME/.testchease > .toto ; mv .toto $HOME/.testchease

fi

cd $curdir
rm -r $tmpdir
