PREFIX=$(HOME)/futils_develop
HDF5=/usr/lib64/mpich2

F90 = mpif90
OPT = -g -fbounds-check -fbacktrace  # only from 4.3.x
OPT = -g -fbounds-check
F90FLAGS = $(OPT) -I${HDF5}/lib -I/usr/include/mpich2-x86_64/
CC = cc
CFLAGS = -O2
LDFLAGS = $(OPT) -L. -L${HDF5}/lib

LIBS =  -lfutils -lhdf5_fortran -lhdf5 -lz

.SUFFIXES:
.SUFFIXES: .o .c .f90

.f90.o:
	$(F90) $(F90FLAGS) -c $<

lib: libfutils.a getfile

getfile: getfile.o
	$(F90) $(LDFLAGS) -o $@ $<  $(LIBS)

libfutils.a: futils.o cutils.o buffer.o vis3d.o
	ar r $@ $?
	ranlib $@

futils.o: append.tpl zappend.tpl \
          putarr.tpl cputarr.tpl putarrnd.tpl cputarrnd.tpl \
          getarr.tpl cgetarr.tpl getarrnd.tpl cgetarrnd.tpl

buffer.o: futils.o

vis3d.o: futils.o

test:
	make -C ../examples test_s test_p

install: debug opt

debug:
	make distclean
	make "OPT = -g -fbounds-check" libfutils.a
	mkdir -p $(PREFIX)/{lib,include}/g
	cp -p libfutils.a $(PREFIX)/lib/g
	cp -p *.mod $(PREFIX)/include/g

opt:
	make distclean
	make "OPT = -O2" libfutils.a
	mkdir -p $(PREFIX)/{lib,include}/O
	cp -p libfutils.a $(PREFIX)/lib/O
	cp -p *.mod $(PREFIX)/include/O

uninstall:
	rm -f $(PREFIX)/include{O,g}/futils.mod
	rm -f $(PREFIX)/include{O,g}/hashtable.mod
	rm -f $(PREFIX)/include{O,g}/vis3d.mod
	rm -f $(PREFIX)/lib{O,g}/libfutils.a

getfile.o:	libfutils.a

clean:
	rm -f *.o *~ a.out fort.* *.h5*

distclean: clean
	rm -f getfile *.a *.mod TAGS
