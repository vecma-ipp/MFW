PREFIX=$(HOME)/sw/${PE_ENV}/futils

F90 = ftn
OPT = -g
F90FLAGS = $(OPT)
CC = cc
CFLAGS = -O2
LDFLAGS = $(OPT) -L.
LIBS =  -lfutils -lhdf5_fortran -lhdf5 -lz

ifeq ($(PE_ENV),CRAY)
     F90FLAGS += -e m
endif

.SUFFIXES:
.SUFFIXES: .o .c .f90

.f90.o:
	$(F90) $(F90FLAGS) -c $<

lib: libfutils.a getfile

getfile: getfile.o
	$(F90) $(LDFLAGS) -o $@ $<  $(LIBS)

libfutils.a: futils.o cutils.o buffer.o vis3d.o
	ar r $@ $?
	ranlib $@

futils.o: append.tpl zappend.tpl \
          putarr.tpl cputarr.tpl putarrnd.tpl cputarrnd.tpl \
          getarr.tpl cgetarr.tpl getarrnd.tpl cgetarrnd.tpl

buffer.o: futils.o

vis3d.o: futils.o

test:
	make -C ../examples test_s test_p -f Makefile.rosa

install: debug opt

debug:
	make -f Makefile.rosa distclean
	make -f Makefile.rosa "OPT = -g " libfutils.a
	mkdir -p $(PREFIX)/g
	cp -p libfutils.a $(PREFIX)/g
	cp -p *.mod $(PREFIX)/g

opt:
	make -f Makefile.rosa distclean
	make -f Makefile.rosa "OPT = -O3 " libfutils.a
	mkdir -p $(PREFIX)/O
	cp -p libfutils.a $(PREFIX)/O
	cp -p *.mod $(PREFIX)/O

uninstall:
	rm -f $(PREFIX)/include{O,g}/futils.mod
	rm -f $(PREFIX)/include{O,g}/vis3d.mod
	rm -f $(PREFIX)/include{O,g}/hashtable.mod
	rm -f $(PREFIX)/lib{O,g}/libfutils.a

getfile.o:	libfutils.a

clean:
	rm -f *.o *~ a.out fort.* *.h5*

distclean: clean
	rm -f getfile *.a *.mod TAGS
