# make each library by default 

default: $(LIB)

# ITM setup

ifeq ($(ITM_ENVIRONMENT_LOADED),yes)
IFLAGS	= $(shell eval-pkg-config --cflags itmtypes-${ITM_INTEL_OBJECTCODE})
IFLAGS	+= $(shell eval-pkg-config --cflags itmconstants-${ITM_INTEL_OBJECTCODE})
IFLAGS	+= $(shell eval-pkg-config --cflags xmllib-${ITM_INTEL_OBJECTCODE})
IFLAGS	+= $(shell eval-pkg-config --cflags ual-${ITM_INTEL_OBJECTCODE})
IFLAGS	+= $(shell eval-pkg-config --cflags libbds-${ITM_INTEL_OBJECTCODE})
else
IFLAGS	= 
endif

# machine dependent stuff, defaults first

include	Makefile.$(SYS)

FPPFLAGS := $(filter-out -DPERF,$(FPPFLAGS))

LIBS	 = 

ifeq ($(ITM_ENVIRONMENT_LOADED),yes)
LDFLAGS	+= $(shell eval-pkg-config --libs itmtypes-${ITM_INTEL_OBJECTCODE})
LDFLAGS	+= $(shell eval-pkg-config --libs itmconstants-${ITM_INTEL_OBJECTCODE})
LDFLAGS	+= $(shell eval-pkg-config --libs xmllib-${ITM_INTEL_OBJECTCODE})
LDFLAGS	+= $(shell eval-pkg-config --libs ual-${ITM_INTEL_OBJECTCODE})
LDFLAGS	+= $(shell eval-pkg-config --libs libbds-${ITM_INTEL_OBJECTCODE})
endif

LDFLAGS	+= -L$(ITM_UAL) -litm $(FFTFLAGS)

# kepler needs

FFLAGS	+= -fPIC

# wrapper objects

WOBJ	= wrapper.o 

# dependences

$(MOD): $(HDR)

$(OBJ): $(MOD)

$(LIB): $(OBJ)
	ar ru $(LIB) $(OBJ) $(MOD)
	ranlib $(LIB) 

clean:
	rm -f *.o *.mod *.M *.[fhFH]90 *.a 
	rm -f `find . -type f -perm 755 -size +20 -print`
	rm -f `find . -type f -perm 751 -size +20 -print`
	rm -f fout* wrapper *.dat 
#	mv *.x?? inputs

again: clean
	make $(LIB)

wrapper: $(LIB) $(WOBJ)
	$(FC90) -o $@ $(WOBJ) $(LIB) $(LIBS) $(LDFLAGS) 

run: wrapper
	./wrapper

